<!DOCTYPE html>
<html lang="en">
<head>
	<style>canvas{
	background-color: rgba(0,0,0,0.8);
}</style>
</head>
<body>
	<canvas id="chart" style="width:100%;"></canvas>
	<div id='info'></div>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script type="text/javascript">
		const canvas = document.querySelector('#chart')
	const ctx = document.querySelector('#chart').getContext('2d');
        const label = []
        const value = []
        const validvalue = []

const toolTipDiv = document.querySelector('#customToolTip')
        let maxvalue,minvalue,data;

        const gradient = ctx.createLinearGradient(0,0,canvas.width,canvas.height)
        gradient.addColorStop(0,"red");
        gradient.addColorStop(0.7,"red");
       gradient.addColorStop(1,'rgba(255,0,0,0.4)')
       ctx.fillStyle = gradient;
       ctx.fillRect(0,0,canvas.width,canvas.height)
        async function fetchData(){
		await fetch("https://financialmodelingprep.com/api/v3/historical-chart/5min/KEYS?apikey=c38b723e031c88753f0c9e66f505f557").then(res =>res.json()).then(info =>data = info).then(()=>console.log(data))
		await formatData()
		createChart()

        }
		function formatData(){
			
		const newdata = Object.entries(data).sort((([,a],[,b]) =>{
		return new Date(a.date)- new Date(b.date)
		}
		))
		console.log(newdata)
       console.log(newdata)
        newdata.forEach((item,index)=>{
        	//if(index <500){
        	const nowdate = new Date();
			const date = new Date(item[1].date);
			if(nowdate.getDate() === date.getDate()){
	
			label.push(date.getHours())

		    validvalue.push(item[1])
		    const price = ((item[1].close + item[1].open)/2).toFixed(2)
			value.push(price)
	        }
			
		//}
		})

		maxvalue = Math.max.apply(null,value)
		minvalue = Math.min.apply(null,value)
		console.log(maxvalue)
		}
		function createChart(){
  		console.log(label) 
  		console.log(validvalue)        
const ctx = document.getElementById('chart').getContext('2d');
        	const annotation = {
    		id:'annotationline',
        	beforeDraw: chart =>{
        		this.tool = chart.tooltip
        		if(this.tool._active && this.tool._active.length){
        			const context =  chart.ctx
        			context.save();
        			context.fillStyle = 'black'
        			const hoverpoint = this.tool._active[0];
        			ctx.setLineDash([])
        			context.beginPath();
        			context.moveTo(this.tool._active[0].element.x,chart.chartArea.top);
        			context.lineTo(this.tool._active[0].element.x,chart.chartArea.bottom)
        			context.lineWidth =10;

        			context.strokeStyle = 'black';
        			context.stroke();
        			context.restore()
    
    }
}
}
var horizonalLinePlugin = {
    id: 'horizontalLine',
    afterDraw: function(chartInstance) {
    var yScale = chartInstance.scales["y"];
    // chartInstance.chart is undefined
    //var ctx = chartInstance.chart;
   // console.log(ctx);
   // var ctx = ctx.ctx;
    var index;
    var line;
    var style; 

    if (chartInstance.options.horizontalLine) {
      for (index = 0; index < chartInstance.options.horizontalLine.length; index++) {
        line = chartInstance.options.horizontalLine[index];
       
        style ='white'

        if (line.y) {
          yValue = yScale.getPixelForValue(line.y);
        } else {
          yValue = 0;
        }

        ctx.lineWidth = 3;

        if (yValue) {
        	 ctx.setLineDash([5, 3])
          ctx.beginPath();

          ctx.moveTo(0, yValue);
          ctx.lineTo(document.querySelector('#chart').width, yValue);
          ctx.strokeStyle = style;
          ctx.stroke();
        }

        if (line.text) {
          ctx.fillStyle = style;
          ctx.fillText(line.text, 0, yValue + ctx.lineWidth);
        }
      }
      return;
    }
  }
};


Chart.register(horizonalLinePlugin);
const myChart = new Chart(ctx, {
    type: 'line',

    data: {
        labels: label,
        datasets: [{
            label: 'stock price',
            data: value,
            fill: true,
            backgroundColor: gradient,
            pointHoverRadius: 0,
             hoverBackgroundColor:'red',
             hoverBorderColor:'green',
            borderColor:'blue'

        }]
    },
    options: {
    	tooltips: {enabled: false},
hover: {mode: null},
        "horizontalLine": [{
      "y": 160,
      "style": "black",
      "text": "upper-limit"
    }, {
      "y": 150,
      "style": "#00ff00",
      "text": "avg"
    }],

    	interaction: {
            mode: 'index',
                  intersect: false,

        },
    	elements:{
    		point:{
    			radius:0,
    			pointHoverRadius: 5
    		}
    	},
        hover:{
           mode:'dataset',
           intersect:false,

        },
        scales: {
        	y:{
               max: Math.ceil(maxvalue),
               min: Math.floor(minvalue),
               grid:{
               	color:'rgba(255,255,255,0.4)'           	
               },
               ticks:{

               	stepSize:2
               }
            
        	},
        	x:{
        		grid:{
        			color:"rgba(255,255,255,0.4)"
        		},
        		ticks:{
        			stepSize:10
        		}
        	}
      
        },
        plugins: {
        	tooltip:{
        		yAlign: "bottom",
        		backgroundColor:'transparent',
        		titleColor:'transparent',
        		displayColors:false,
        		bodyColor:'transparent',
        		footerColor:'transparent',
             callbacks: {
    label: function(tooltipItem, data) {
    	console.log(tooltipItem);
    	console.log(validvalue[tooltipItem.dataIndex])
    	document.querySelector('#info').textContent = tooltipItem.raw+validvalue[tooltipItem.dataIndex].date
					return tooltipItem;
     
    }
},
        	}
        }
    },
    plugins: [annotation]

});
}
		
		window.onload =fetchData;

		



	</script>
</body>
</html>
